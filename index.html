<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hit/Crit Calculator</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    label { display:block; font-size:12px; opacity:0.8; }
    input { width:90px; padding:6px; font-size:14px; }
    button { padding:8px 12px; font-size:14px; cursor:pointer; }
    #summary { margin: 12px 0; font-weight: 600; white-space: pre-line; }
    #plot { width: 100%; max-width: 980px; height: 520px; }
  </style>
</head>
<body>
  <h2>Exact Hit / Crit Calculator</h2>
  <div class="row">
    <div><label>ATK</label><input id="atk" type="number" value="0"></div>
    <div><label>DEF</label><input id="def" type="number" value="0"></div>
    <button id="run" disabled>Compute</button>
  </div>
  <div id="summary">Loading Python runtime…</div>
  <div id="plot"></div>

<script>
let pyodide;

async function init() {
  pyodide = await loadPyodide();
  document.getElementById("run").disabled = false;
  document.getElementById("summary").textContent = "Ready.";
  await computeAndPlot();
}

async function computeAndPlot() {
  const ATK = parseInt(document.getElementById("atk").value || "0", 10);
  const DEF = parseInt(document.getElementById("def").value || "0", 10);

  const code = `
from collections import Counter
import json

# Final rules (no U):
# A = 2d10 + ATK
# Hit if A >= DEF + 7  <=>  (A - DEF) >= 7
# Crit if A >= 20 (absolute; does NOT depend on DEF)

HIT_T = 7
CRIT_A = 20

# Build shifted distribution for plotting: X = (2d10 + ATK - DEF)
dist = Counter()
total = 0

# Compute hit/crit frequencies using the correct variables:
# - Hit check uses X = A - DEF
# - Crit check uses A (absolute)
success_freq = 0
crit_freq = 0

for d10a in range(1, 11):
    for d10b in range(1, 11):
        A = d10a + d10b + ${ATK}
        X = A - ${DEF}
        dist[X] += 1
        total += 1

        if X >= HIT_T:
            success_freq += 1
            if A >= CRIT_A:
                crit_freq += 1

xs = sorted(dist.keys())
ys = [dist[x]/total*100 for x in xs]

payload = {
  "xs": xs,
  "ys": ys,
  "success_freq": success_freq,
  "crit_freq": crit_freq,
  "total": total,
  "HIT_T": HIT_T,
  "CRIT_A": CRIT_A
}
json.dumps(payload)
  `;

  const payloadJSON = await pyodide.runPythonAsync(code);
  const payload = JSON.parse(payloadJSON);

  const xs = payload.xs;
  const ys = payload.ys;
  const HIT_T = payload.HIT_T;     // threshold on X = A - DEF
  const CRIT_A = payload.CRIT_A;   // absolute crit threshold on A

  // For coloring/shading on the plotted x-axis (which is X = A - DEF),
  // the crit region starts at X >= (CRIT_A - DEF) because A = X + DEF.
  const critThresholdOnX = CRIT_A - DEF;

  // Color per bin on X-axis:
  // fail (<HIT_T), crit (>=critThresholdOnX), else success
  const colors = xs.map(x =>
    (x < HIT_T) ? "red" :
    (x >= critThresholdOnX) ? "cyan" :
    "green"
  );

  const successRate = payload.success_freq / payload.total * 100;
  const critRate = payload.crit_freq / payload.total * 100;
  const critOnHit = payload.success_freq > 0 ? (payload.crit_freq / payload.success_freq * 100) : 0;

  document.getElementById("summary").textContent =
    `Rules: A = 2d10 + ATK; Hit if A ≥ DEF + 7; Crit if A ≥ 20 (crit ignores DEF)\n` +
    `Success: ${successRate.toFixed(3)}% (${payload.success_freq}/${payload.total})\n` +
    `Crit:    ${critRate.toFixed(3)}% (${payload.crit_freq}/${payload.total})\n` +
    `Crit|Hit:${critOnHit.toFixed(3)}% (${payload.crit_freq}/${payload.success_freq})\n` +
    `Plotted axis: X = A − DEF = 2d10 + ATK − DEF\n` +
    `Hit threshold on X: ≥ ${HIT_T}\n` +
    `Crit condition: A ≥ ${CRIT_A} (equivalently on X: ≥ ${critThresholdOnX})`;

  const trace = {
    x: xs,
    y: ys,
    type: "bar",
    marker: { color: colors, line: { color: "black", width: 1 } },
    hovertemplate: "X=A−DEF=%{x}<br>%{y:.3f}%<extra></extra>"
  };

  const hitLineX = HIT_T - 0.5;
  const critLineX = critThresholdOnX - 0.5;

  const layout = {
    title: `Exact Distribution: X = 2d10 + ATK(${ATK}) - DEF(${DEF})`,
    xaxis: { title: "X = A − DEF", dtick: 1 },
    yaxis: { title: "Frequency (%)", rangemode: "tozero" },
    shapes: [
      // Hit threshold line
      { type:"line", x0:hitLineX, x1:hitLineX, y0:0, y1:1, xref:"x", yref:"paper",
        line:{color:"black", width:2, dash:"dash"} },

      // Crit threshold line on X-axis (corresponding to A>=20)
      { type:"line", x0:critLineX, x1:critLineX, y0:0, y1:1, xref:"x", yref:"paper",
        line:{color:"black", width:2, dash:"dash"} },

      // Failure shade (X < HIT_T)
      { type:"rect", x0:xs[0]-0.5, x1:hitLineX, y0:0, y1:1, xref:"x", yref:"paper",
        fillcolor:"rgba(255,0,0,0.15)", line:{width:0} },

      // Crit shade (A >= 20 => X >= CRIT_A - DEF)
      { type:"rect", x0:critLineX, x1:xs[xs.length-1]+0.5, y0:0, y1:1, xref:"x", yref:"paper",
        fillcolor:"rgba(0,255,255,0.15)", line:{width:0} }
    ],
    margin: { t: 60, r: 20, b: 60, l: 60 }
  };

  Plotly.newPlot("plot", [trace], layout, {displayModeBar: false});
}

document.getElementById("run").addEventListener("click", computeAndPlot);
init();
</script>
</body>
</html>
